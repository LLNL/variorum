name: Variorum CI

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev, releases/** ]

jobs:
  check-code-format:
    runs-on: ubuntu-latest

    steps:
    - name: Style check c/cpp/h files
      run: |
        wget https://sourceforge.net/projects/astyle/files/astyle/astyle%203.1/astyle_3.1_linux.tar.gz
        tar -xf astyle_3.1_linux.tar.gz
        cd astyle/build/gcc && make -j
        export PATH="${PWD}/bin:${PATH}"
        cd -
        echo -e "PWD:" ${PWD}
        ../../scripts/astyle-format.sh

    - name: Install python dependencies
      run: |
        python -m pip install --upgrade pip flake8
        pip install -r ../../src/utilities/requirements.txt

    - name: Update Black
      if: ${{ matrix.python-version == 3.7 }}
      run: |
        pip install --upgrade black

    - name: Style check python files
      if: ${{ matrix.python-version == 3.7 }}
      run: |
        black --diff --check .
        flake8

  build:
    runs-on: ubuntu-latest

    strategy:
       include:
         - BUILD_SHARED_LIBS: ON
           BUILD_DOCS: ON
           BUILD_TESTS: OFF
           CMAKE_BUILD_TYPE: Debug
           ENABLE_FORTRAN: OFF
           VARIORUM_DEBUG: ON
           VARIORUM_LOG: ON
         - BUILD_SHARED_LIBS: ON
           BUILD_DOCS: ON
           BUILD_TESTS: OFF
           CMAKE_BUILD_TYPE: Debug
           ENABLE_FORTRAN: OFF
           VARIORUM_DEBUG: OFF
           VARIORUM_LOG: OFF
         - BUILD_SHARED_LIBS: ON
           BUILD_DOCS: OFF
           BUILD_TESTS: OFF
           CMAKE_BUILD_TYPE: Debug
           ENABLE_FORTRAN: OFF
           VARIORUM_DEBUG: ON
           VARIORUM_LOG: ON
         - BUILD_SHARED_LIBS: ON
           BUILD_DOCS: OFF
           BUILD_TESTS: OFF
           CMAKE_BUILD_TYPE: Debug
           ENABLE_FORTRAN: OFF
           VARIORUM_DEBUG: OFF
           VARIORUM_LOG: OFF
         - BUILD_SHARED_LIBS: OFF
           BUILD_DOCS: ON
           BUILD_TESTS: OFF
           CMAKE_BUILD_TYPE: Debug
           ENABLE_FORTRAN: OFF
           VARIORUM_DEBUG: OFF
           VARIORUM_LOG: ON
         - BUILD_SHARED_LIBS: OFF
           BUILD_DOCS: ON
           BUILD_TESTS: OFF
           CMAKE_BUILD_TYPE: Debug
           ENABLE_FORTRAN: OFF
           VARIORUM_DEBUG: ON
           VARIORUM_LOG: OFF
         - BUILD_SHARED_LIBS: OFF
           BUILD_DOCS: OFF
           BUILD_TESTS: OFF
           CMAKE_BUILD_TYPE: Debug
           ENABLE_FORTRAN: OFF
           VARIORUM_DEBUG: ON
           VARIORUM_LOG: ON
         - BUILD_SHARED_LIBS: OFF
           BUILD_DOCS: OFF
           BUILD_TESTS: OFF
           CMAKE_BUILD_TYPE: Debug
           ENABLE_FORTRAN: OFF
           VARIORUM_DEBUG: OFF
           VARIORUM_LOG: OFF
         - BUILD_SHARED_LIBS: ON
           BUILD_DOCS: ON
           BUILD_TESTS: ON
           CMAKE_BUILD_TYPE: Release
           ENABLE_FORTRAN: OFF
           VARIORUM_DEBUG: OFF
           VARIORUM_LOG: ON

    steps:
    - name: Compile check
      run: ../../scripts/travis/build-and-install.sh

  verify-build:

    steps:
    - name: Verify install with example
      env:
        BUILD_SHARED_LIBS: ON
        BUILD_DOCS: OFF
        BUILD_TESTS: OFF
        CMAKE_BUILD_TYPE: Release
        VARIORUM_DEBUG: OFF
        VARIORUM_LOG: OFF
        ENABLE_FORTRAN: ON
      run: |
        sudo apt-get install gfortran
        sudo apt-get install linux-headers-`uname -r`
        ../../scripts/travis/build-and-install.sh
        ../../scripts/travis/load-msr-safe.sh
        ../../scripts/travis/test-install.sh
